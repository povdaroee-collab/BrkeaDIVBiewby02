<!DOCTYPE html>
<html lang="km" class=""> <!-- 'dark' class នឹងត្រូវបានបន្ថែមនៅទីនេះដោយ React -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>កំណត់ត្រានិស្សិត - Firebase Reader</title>
  
  <link rel="shortcut icon" href="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" type="image/x-icon">
  
  <!-- 1. TALLWIND CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. REACT LIBRARIES -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  
  <!-- 3. BABEL STANDALONE -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 4. FIREBASE LIBRARIES (v8 API) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    /* បន្ថែម Font ខ្មែរ ដើម្បីឲ្យស្អាត */
    @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap');
    body {
      font-family: 'Kantumruy Pro', sans-serif;
    }
    /* ការពារការប្តូរទំព័រពេលកំពុងអូស Card */
    .card-container {
      touch-action: pan-y;
    }
    /* សម្រាប់ Animation ពេលប្តូរទំព័រ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    /* សម្រាប់ Modal */
    @keyframes fadeInFast {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .animate-fade-in-fast {
      animation: fadeInFast 0.2s ease-out;
    }
    
    /* សម្រាប់ Background Swatches */
    .bg-swatch {
      width: 100%;
      height: 50px;
      border-radius: 0.5rem;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s ease;
    }
    .bg-swatch.selected {
      border-color: #2563EB; /* blue-600 */
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
    /* Dark mode support for selected border */
    .dark .bg-swatch.selected {
      border-color: #3B82F6; /* blue-500 */
    }
    
    /* Background Patterns */
    .bg-dots {
      background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px); /* Dark mode dots */
    }
    .dark .bg-dots {
       background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
    }
    .bg-gray-800-dots { /* Class សម្រាប់ Dark Mode */
       background-color: #1f2937; /* gray-800 */
    }
    
    .bg-lines {
      background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }
  </style>
</head>
<body class=""> <!-- Background នឹងត្រូវបានកំណត់ដោយ React -->
  
  <div id="root"></div>

  <script type="text/babel">
    
    const { useState, useEffect, useMemo, useCallback } = React;

    // --- Global Firebase Variables ---
    const firebaseConfig = {
      apiKey: "AIzaSyA1YBg1h5PAxu3vB7yKkpcirHRmLVl_VMI",
      authDomain: "brakelist-5f07f.firebaseapp.com",
      databaseURL: "https://brakelist-5f07f-default-rtdb.firebaseio.com",
      projectId: "brakelist-5f07f",
      storageBucket: "brakelist-5f07f.firebasestorage.app",
      messagingSenderId: "1032751366057",
      appId: "1:1032751366057:web:b23f1e7f3a093a496a4eb8",
      measurementId: "G-51RMC51XZW"
    };

    // --- Background Options (UPDATED with isDark) ---
    const backgroundOptions = [
      { id: 'bg-gray-50', name: 'ពណ៌ប្រផេះ (Default)', class: 'bg-gray-50', isDark: false },
      { id: 'bg-white', name: 'ពណ៌ស', class: 'bg-white', isDark: false },
      { id: 'bg-blue-50', name: 'ពណ៌ខៀវខ្ចី', class: 'bg-blue-50', isDark: false },
      { id: 'bg-gray-800-dots', name: 'ងងឹត (Dots)', class: 'bg-gray-800-dots bg-dots', isDark: true },
      { id: 'bg-gray-100-lines', name: 'ប្រផេះ (Lines)', class: 'bg-gray-100 bg-lines', isDark: false },
      { id: 'bg-indigo-50', name: 'ពណ៌ស្វាយខ្ចី', class: 'bg-indigo-50', isDark: false },
    ];

    // --- Helper Function (ថ្ងៃបច្ចុប្បន្ន) ---
    const getTodayDateString = () => {
      const today = new Date(); 
      const year = today.getFullYear();
      const month = (today.getMonth() + 1).toString().padStart(2, '0');
      const day = today.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    // --- Helper Function (បំប្លែង URL អក្សរខ្មែរ) ---
    const encodeUrlIfNeeded = (url) => {
      if (!url) return null;
      try {
        if (/[^\x00-\x7F]/.test(url)) {
          const urlObj = new URL(url);
          const protocol = urlObj.protocol;
          const host = urlObj.host;
          const path = urlObj.pathname.split('/').map(segment => encodeURIComponent(segment)).join('/');
          return `${protocol}//${host}${path}`;
        }
        return url;
      } catch (e) {
        console.error("Invalid URL:", url, e);
        return null;
      }
    };
    
    // --- Helper Functions (Formatting) ---
    const formatKey = (key) => {
      const result = key.replace(/([A-Z])/g, ' $1');
      return result.charAt(0).toUpperCase() + result.slice(1);
    };
    const formatDisplayTime = (isoString) => {
      if (!isoString || typeof isoString !== 'string') return '--:--';
      try {
        return new Date(isoString).toLocaleString('en-US', { 
          hour: '2-digit', minute: '2-digit', hour12: true 
        });
      } catch (e) { return isoString; }
    };
    const formatDisplayDate = (isoString) => {
      if (!isoString || typeof isoString !== 'string') return 'N/A';
      try {
        return new Date(isoString).toLocaleDateString('en-GB', { 
          day: 'numeric', month: 'short', year: 'numeric' 
        });
      } catch (e) { return isoString; }
    };

    // --- Main App Component ---
    function App() {
      // Firebase state
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);
      const [userId, setUserId] = useState(null);
      const [isAuthReady, setIsAuthReady] = useState(false);

      // App state
      const [notes, setNotes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      // --- Page Navigation State ---
      const [page, setPage] = useState('list'); // 'list', 'details', 'settings'

      // --- Settings State (UPDATED: Both personal) ---
      const [showOnlyCheckout, setShowOnlyCheckout] = useState(false); // Personal filter
      const [background, setBackground] = useState(backgroundOptions[0].class); // Personal background
      
      // --- Modal State ---
      const [modalImage, setModalImage] = useState(null);

      // Animation states
      const [headerAnimated, setHeaderAnimated] = useState(false);
      const [cardsAnimated, setCardsAnimated] = useState(false);

      // --- Pagination State ---
      const [currentPage, setCurrentPage] = useState(0);
      const CARDS_PER_PAGE = 10;

      // --- Touch Swipe State ---
      const [touchStartX, setTouchStartX] = useState(null);
      const [touchEndX, setTouchEndX] = useState(null);

      // 1. Initialize Firebase, Authenticate, and Load Personal Settings (UPDATED)
      useEffect(() => {
        // Load personal background from localStorage
        const savedBgClass = localStorage.getItem('appBackground') || backgroundOptions[0].class;
        const savedBgOption = backgroundOptions.find(o => o.class === savedBgClass) || backgroundOptions[0];
        
        setBackground(savedBgOption.class);
        if (savedBgOption.isDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }

        // Load personal filter from localStorage (NEW)
        const savedShowOnlyCheckout = localStorage.getItem('showOnlyCheckout');
        setShowOnlyCheckout(savedShowOnlyCheckout === 'true');

        try {
          if (!firebaseConfig.apiKey) throw new Error("Firebase config is missing.");
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          
          const authInstance = firebase.auth();
          const dbInstance = firebase.database();
          
          setDb(dbInstance);
          setAuth(authInstance);
          
          setTimeout(() => setHeaderAnimated(true), 100); 

          const unsubscribeAuth = authInstance.onAuthStateChanged(async (user) => {
            if (user) {
              setUserId(user.uid);
              setIsAuthReady(true);
            } else {
              try {
                await authInstance.signInAnonymously();
              } catch (authError) {
                console.error("Error signing in:", authError);
                setError("បរាជ័យក្នុងការផ្ទៀងផ្ទាត់អត្តសញ្ញាណ។");
                setIsAuthReady(true);
              }
            }
          });
          return () => unsubscribeAuth();
        } catch (e) {
          console.error("Error initializing Firebase:", e);
          setError("បរាជ័យក្នុងការចាប់ផ្តើម Firebase។");
          setLoading(false);
          setIsAuthReady(true);
        }
      }, []);

      // 2. Read Data from Realtime Database (UPDATED: Removed settings listener)
      useEffect(() => {
        if (!isAuthReady || !db || !userId) return; 

        setLoading(true);
        setError(null);
        setCardsAnimated(false);

        // --- Listen for Attendance Data ---
        const todayString = getTodayDateString();
        const todayQuery = db.ref('attendance').orderByChild('date').equalTo(todayString);

        const onValueCallback = (snapshot) => {
          const data = snapshot.val();
          const fetchedNotes = [];

          if (data) {
            Object.keys(data).forEach(key => {
              const value = data[key];
              if (typeof value === 'object' && value !== null) {
                fetchedNotes.push({ id: key, data: value });
              } 
            });
          }

          fetchedNotes.sort((a, b) => {
            const timeA = a.data.checkOutTime ? new Date(a.data.checkOutTime) : new Date(0);
            const timeB = b.data.checkOutTime ? new Date(b.data.checkOutTime) : new Date(0);
            return timeB - timeA;
          });

          setNotes(data === null ? [] : fetchedNotes);
          setLoading(false);
          setCurrentPage(0);
          setTimeout(() => setCardsAnimated(true), 100);
        };
        
        const onErrorCallback = (err) => {
          console.error("Error fetching data:", err);
          setError("បរាជ័យក្នុងការទាញយកទិន្នន័យ។");
          setLoading(false);
        };

        todayQuery.on('value', onValueCallback, onErrorCallback);
        
        return () => {
          todayQuery.off('value', onValueCallback);
        };
      }, [db, userId, isAuthReady]); 

      // 3. Save Personal Background & Toggle Dark Mode (UPDATED)
      const handleBackgroundChange = (bgClass) => {
        const selectedOption = backgroundOptions.find(o => o.class === bgClass) || backgroundOptions[0];
        
        localStorage.setItem('appBackground', selectedOption.class);
        setBackground(selectedOption.class);
        
        // Toggle Dark Mode
        if (selectedOption.isDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        // Apply to body tag for full page effect
        document.body.className = selectedOption.class;
      };

      // Apply body class on initial load
      useEffect(() => {
        document.body.className = background;
      }, [background]);


      // --- Personal Setting Write Function (UPDATED) ---
      const handleFilterToggle = () => {
        const newValue = !showOnlyCheckout;
        localStorage.setItem('showOnlyCheckout', newValue); // Save to localStorage
        setShowOnlyCheckout(newValue); // Update state
      };

      // --- Filtered Notes Logic (for List Page) ---
      const filteredNotes = useMemo(() => {
        if (!showOnlyCheckout) {
          return notes; // If filter is off, return all notes
        }
        // If filter is on, return only notes WITHOUT a checkInTime
        return notes.filter(note => !note.data.checkInTime);
      }, [notes, showOnlyCheckout]);


      // --- Pagination Logic (uses filteredNotes) ---
      const totalPages = Math.ceil(filteredNotes.length / CARDS_PER_PAGE);
      const currentNotes = filteredNotes.slice(
        currentPage * CARDS_PER_PAGE,
        (currentPage + 1) * CARDS_PER_PAGE
      );

      const goToPage = (pageIndex) => {
        if (pageIndex < 0 || pageIndex >= totalPages) return;
        
        setCardsAnimated(false);
        setTimeout(() => {
          setCurrentPage(pageIndex);
          setCardsAnimated(true);
        }, 150);
      };

      const handlePrevPage = () => goToPage(currentPage - 1);
      const handleNextPage = () => goToPage(currentPage + 1);

      // --- Touch Swipe Handlers ---
      const handleTouchStart = (e) => {
        if (page !== 'list') return;
        setTouchEndX(null);
        setTouchStartX(e.targetTouches[0].clientX);
      };
      const handleTouchMove = (e) => {
        if (page !== 'list') return;
        setTouchEndX(e.targetTouches[0].clientX);
      };
      const handleTouchEnd = () => {
        if (page !== 'list') return;
        if (!touchStartX || !touchEndX) return;
        const diff = touchStartX - touchEndX;
        const swipeThreshold = 50; 

        if (diff > swipeThreshold) {
          handleNextPage();
        } else if (diff < -swipeThreshold) {
          handlePrevPage();
        }
        setTouchStartX(null);
        setTouchEndX(null);
      };

      // --- Calculations for Details Page (uses all 'notes') ---
      const stats = useMemo(() => {
        if (loading || notes.length === 0) {
          return { totalStudents: 0, studentsOut: 0, totalRecords: 0 };
        }
        
        const totalRecords = notes.length;
        const uniqueStudentIds = [...new Set(notes.map(note => note.data.studentId))].length;
        const recordsOut = notes.filter(note => note.data.checkOutTime && !note.data.checkInTime);
        const uniqueStudentsOut = [...new Set(recordsOut.map(note => note.data.studentId))].length;

        return { totalStudents: uniqueStudentIds, studentsOut: uniqueStudentsOut, totalRecords: totalRecords };
      }, [notes, loading]);

      // --- Export Functions ---
      const formatForShare = () => {
        const today = formatDisplayDate(new Date().toISOString());
        let text = `*** របាយការណ៍សរុបប្រចាំថ្ងៃ ***\n`;
        text += `កាលបរិច្ឆេទ: ${today}\n\n`;
        
        text += `--- ស្ថិតិ ---`;
        text += `\n- និស្សិតកំពុងនៅខាងក្រៅ: ${stats.studentsOut} នាក់`;
        text += `\n- ចំនួននិស្សិតសរុប (Unique): ${stats.totalStudents} នាក់`;
        text += `\n- កំណត់ត្រាសរុប: ${stats.totalRecords}  transactions\n\n`;
        
        text += `--- កំណត់ត្រាលម្អិត ---`;
        if(notes.length === 0) {
          text += `\nមិនមានទិន្នន័យ។`;
        } else {
          notes.forEach((note, index) => {
            const d = note.data;
            const name = d.studentName || d.name || `ID: ${d.studentId}`;
            const outTime = formatDisplayTime(d.checkOutTime);
            const inTime = formatDisplayTime(d.checkInTime);
            text += `\n${index + 1}. ${name}`;
            text += `\n   (ចេញ: ${outTime} | ចូល: ${inTime})`;
          });
        }
        return text;
      };

      const handleShareToTelegram = () => {
        const text = formatForShare();
        const telegramUrl = `tg://msg_url?text=${encodeURIComponent(text)}`;
        window.open(telegramUrl, '_blank');
      };

      // --- Render UI (JSX) ---
      return (
        <React.Fragment>
          {/* Main container class is now dynamic from state */}
          <div className={`flex flex-col h-screen font-sans overflow-hidden transition-colors duration-300 ${background} dark:text-gray-200`}>
            
            {/* Header Bar */}
            <div className={`w-full bg-gradient-to-r from-blue-600 to-indigo-700 shadow-lg relative z-10 flex-shrink-0 transition-all duration-700 ease-out transform ${
                headerAnimated ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-12'
              }`}>
              <div className="w-full max-w-3xl mx-auto p-5 flex flex-row items-center justify-center"> {/* Justify-center */}
                
                {/* ចំណងជើង (នៅកណ្តាល) */}
                <div className="flex flex-row items-center justify-center space-x-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 text-white opacity-90">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h1 className="text-2xl font-bold text-white text-center">
                    {page === 'list' && 'និស្សិតចេញចូលម៉ោងការងារ'}
                    {page === 'details' && 'សរុបប្រចាំថ្ងៃ'}
                    {page === 'settings' && 'ការកំណត់'}
                  </h1>
                </div>

              </div>
            </div>

            {/* Main Content Area (Scrollable) */}
            <div className="w-full max-w-3xl mx-auto p-4 flex-grow overflow-y-auto pb-24"> {/* Added pb-24 for footer space */}
              
              {error && (
                <div className="p-4 my-4 text-center text-red-800 bg-red-100 rounded-lg shadow">
                  <span className="font-semibold">មានបញ្ហា៖</span> {error}
                </div>
              )}

              {/* ប្រើ currentNotes សម្រាប់ ListPage (ដែលបានត្រង (Filter) រួច) */}
              {page === 'list' && <ListPage loading={loading} notes={currentNotes} totalPages={totalPages} currentPage={currentPage} handlePrevPage={handlePrevPage} handleNextPage={handleNextPage} handleTouchStart={handleTouchStart} handleTouchMove={handleTouchMove} handleTouchEnd={handleTouchEnd} cardsAnimated={cardsAnimated} setModalImage={setModalImage} />}
              
              {page === 'details' && <DetailsPage loading={loading} stats={stats} handleShareToTelegram={handleShareToTelegram} />}
              
              {page === 'settings' && <SettingsPage showOnlyCheckout={showOnlyCheckout} onFilterToggle={handleFilterToggle} currentBackground={background} onBackgroundChange={handleBackgroundChange} />}

            </div>

            {/* === Footer Navigation Bar (NEW) === */}
            <div className="w-full bg-white dark:bg-gray-800 shadow-inner sticky bottom-0 z-10 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
              <div className="w-full max-w-3xl mx-auto px-4 py-2 flex justify-around items-center">
                
                {/* Nav Item: List */}
                <button
                  onClick={() => setPage('list')}
                  className={`flex flex-col items-center justify-center w-full p-2 rounded-lg transition-colors ${
                    page === 'list' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                  }`}
                >
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={page === 'list' ? 2 : 1.5} stroke="currentColor" className="w-6 h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                  </svg>
                  <span className="text-xs font-medium mt-1">បញ្ជី</span>
                </button>

                {/* Nav Item: Details */}
                <button
                  onClick={() => setPage('details')}
                  className={`flex flex-col items-center justify-center w-full p-2 rounded-lg transition-colors ${
                    page === 'details' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                  }`}
                >
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={page === 'details' ? 2 : 1.5} stroke="currentColor" className="w-6 h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V5.75A2.25 2.25 0 0018 3.5H6A2.25 2.25 0 003.75 5.75v12.5A2.25 2.25 0 006 20.25z" />
                  </svg>
                  <span className="text-xs font-medium mt-1">សរុប</span>
                </button>

                {/* Nav Item: Settings */}
                <button
                  onClick={() => setPage('settings')}
                  className={`flex flex-col items-center justify-center w-full p-2 rounded-lg transition-colors ${
                    page === 'settings' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                  }`}
                >
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={page === 'settings' ? 2 : 1.5} stroke="currentColor" className="w-6 h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.227l-.11.023c.554-.22 1.156-.22 1.71 0l.11-.023c.55.22 1.02.685 1.11 1.227l.11-.023a8.25 8.25 0 000 2.4l-.11.023a1.125 1.125 0 01-1.11 1.227l.11-.023c.554.22 1.156.22 1.71 0l.11.023c.55.22 1.02.685 1.11 1.227l.11-.023a8.25 8.25 0 000 2.4l-.11.023a1.125 1.125 0 01-1.11 1.227l.11-.023c.554.22 1.156.22 1.71 0l.11.023c.55.22 1.02.685 1.11 1.227l.11-.023a8.25 8.25 0 000 2.4l-.11.023a1.125 1.125 0 01-1.11 1.227l.11-.023c.554.22 1.156.22 1.71 0l.11.023c.55.22 1.02.685 1.11 1.227l.11-.023a8.25 8.25 0 000 2.4l-.11.023a1.125 1.125 0 01-1.11 1.227l.11-.023a8.25 8.25 0 00-2.4 0l.11.023a1.125 1.125 0 01-1.227 1.11l-.023-.11a8.25 8.25 0 00-2.4 0l-.023.11a1.125 1.125 0 01-1.227-1.11l-.023.11a8.25 8.25 0 00-2.4 0l-.023-.11a1.125 1.125 0 01-1.227-1.11l-.023.11a8.25 8.25 0 00-2.4 0l-.023.11a1.125 1.125 0 01-1.227 1.11l-.023-.11a8.25 8.25 0 00-2.4 0l-.023.11a1.125 1.125 0 01-1.227-1.11l-.023.11a8.25 8.25 0 00-2.4 0l-.023-.11a1.125 1.125 0 01-1.227-1.11l-.023.11a8.25 8.25 0 000-2.4l.023.11a1.125 1.125 0 011.11-1.227l-.023.11c-.22-.554-.22-1.156 0-1.71l.023-.11a1.125 1.125 0 011.11-1.227l-.023.11c-.22-.554-.22-1.156 0-1.71l.023-.11a1.125 1.125 0 011.11-1.227l-.023.11c-.22-.554-.22-1.156 0-1.71l.023-.11a1.125 1.125 0 011.11-1.227l-.023.11a8.25 8.25 0 000-2.4l.023.11C9.323 4.625 9.793 4.16 10.343 3.94zM12 15a3 3 0 100-6 3 3 0 000 6z" />
                  </svg>
                  <span className="text-xs font-medium mt-1">កំណត់ត្រា</span>
                </button>
                
              </div>
            </div>

          </div>

          {/* === Modal Container === */}
          {modalImage && (
            <ImageModal 
              imageUrl={modalImage} 
              onClose={() => setModalImage(null)} 
            />
          )}
        </React.Fragment>
      );
    }

    // --- Sub-Component: List Page ---
    function ListPage({ loading, notes, totalPages, currentPage, handlePrevPage, handleNextPage, handleTouchStart, handleTouchMove, handleTouchEnd, cardsAnimated, setModalImage }) {
      return (
        <React.Fragment>
          {/* Card List Container (with swipe handlers) */}
          <div 
            className="space-y-3 card-container"
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
          >
            {loading && (
              <div className="flex justify-center items-center py-10">
                <svg className="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span className="ml-3 text-gray-600 dark:text-gray-300">កំពុងទាញយកទិន្នន័យ...</span>
              </div>
            )}
            
            {!loading && notes.length === 0 && (
              <div className="flex flex-col items-center justify-center py-10 text-center text-gray-500 dark:text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-12 h-12 text-gray-400">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                </svg>
                <h3 className="text-lg font-semibold mt-2">មិនទាន់មានទិន្នន័យ</h3>
                <p className="text-sm">មិនមានកំណត់ត្រាសម្រាប់ថ្ងៃបច្ចុប្បន្ននេះទេ។</p>
              </div>
            )}

            {!loading && notes.map((note, index) => {
              
              const knownFields = new Set([
                'studentId', 'passNumber', 'checkInTime', 'checkOutTime', 'date', 'breakType', 
                'studentName', 'name', 'photoURL', 'imageUrl', 'Student Photo Url', 'studentPhotoUrl'
              ]);
              
              const { data } = note;
              
              const displayName = data.studentName || data.name;
              const displayPhoto = encodeUrlIfNeeded(data['Student Photo Url'] || data.studentPhotoUrl || data.photoURL || data.imageUrl);

              const otherData = Object.keys(data)
                .filter(key => !knownFields.has(key) && data[key])
                .reduce((obj, key) => {
                  obj[key] = data[key];
                  return obj;
                }, {});

              return (
                <div
                  key={note.id}
                  className={`bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden transition-all duration-500 ease-out transform hover:-translate-y-1 hover:shadow-xl dark:shadow-gray-900 dark:hover:shadow-gray-700 ${
                    cardsAnimated 
                      ? 'opacity-100 translate-y-0 scale-100' 
                      : 'opacity-0 translate-y-5 scale-95'
                  } ${
                    displayPhoto ? 'cursor-pointer' : ''
                  }`}
                  style={{ transitionDelay: `${index * 100}ms` }}
                  onClick={() => {
                    if (displayPhoto) {
                      setModalImage(displayPhoto);
                    }
                  }}
                >
                  {/* === Card Header === */}
                  <div className="p-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 relative">
                    {data.passNumber && (
                      <div className="absolute top-4 right-4 flex items-center space-x-1.5 bg-blue-600 text-white px-3 py-1 rounded-full shadow-md text-xs font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-4 h-4">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M15 9H9.75M15 12H9.75M15 15H9.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                        </svg>
                        <span>{data.passNumber}</span>
                      </div>
                    )}
                    <div className="flex items-center space-x-3">
                      <div className="flex-shrink-0 w-12 h-12 rounded-full overflow-hidden bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                        {displayPhoto ? (
                          <img 
                            src={displayPhoto} 
                            alt={displayName || 'Student'} 
                            className="w-full h-full object-cover" 
                            referrerPolicy="no-referrer" 
                            onError={(e) => {
                              e.target.style.display = 'none'; 
                              e.target.nextSibling.style.display = 'flex';
                            }} 
                          />
                        ) : null}
                        <div 
                          className="w-full h-full flex items-center justify-center" 
                          style={{ display: displayPhoto ? 'none' : 'flex' }}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 text-blue-600 dark:text-blue-300">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                          </svg>
                        </div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-gray-900 dark:text-white">{displayName || 'មិនមានឈ្មោះ'}</div>
                        <div className="text-sm font-semibold text-gray-500 dark:text-gray-400">ID: {data.studentId || 'N/A'}</div>
                      </div>
                    </div>
                  </div>

                  {/* === Card Body === */}
                  <div className="p-4">
                    <div className="flex justify-between items-center">
                      <div className="flex items-center space-x-2">
                        <div className="flex-shrink-0 p-2 bg-red-100 dark:bg-red-900/50 rounded-full">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5 text-red-600 dark:text-red-400">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l3-3m0 0l-3-3m3 3H9" />
                          </svg>
                        </div>
                        <div className="text-left">
                          <div className="text-xs font-medium text-gray-500 dark:text-gray-400">ម៉ោងចេញ</div>
                          <div className="text-base font-bold text-gray-900 dark:text-white">{formatDisplayTime(data.checkOutTime)}</div>
                        </div>
                      </div>
                      <div className="flex-grow border-t-2 border-dotted border-gray-300 dark:border-gray-600 mx-3"></div>
                      <div className="flex items-center space-x-2">
                        <div className="text-right">
                          <div className="text-xs font-medium text-gray-500 dark:text-gray-400">ម៉ោងចូល</div>
                          <div className="text-base font-bold text-gray-900 dark:text-white">{formatDisplayTime(data.checkInTime)}</div>
                        </div>
                        <div className="flex-shrink-0 p-2 bg-green-100 dark:bg-green-900/50 rounded-full">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5 text-green-600 dark:text-green-400">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M15.75 9l-2.25-2.25m0 0l-2.25 2.25M13.5 6.75v10.5" />
                          </svg>
                        </div>
                      </div>
                    </div>
                    <div className="flex justify-between items-center mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 text-xs">
                      <div className="flex items-center space-x-2 text-gray-700 dark:text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 text-yellow-600 dark:text-yellow-500 flex-shrink-0">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                          <path strokeLinecap="round" strokeLinejoin="round" d="M6 6h.008v.008H6V6z" />
                        </svg>
                        <span className="capitalize">{data.breakType || 'N/A'}</span>
                      </div>
                      <div className="flex items-center space-x-2 text-gray-500 dark:text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 text-indigo-500 dark:text-indigo-400 flex-shrink-0">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                        </svg>
                        <span>{formatDisplayDate(data.date)}</span>
                      </div>
                    </div>
                    {Object.keys(otherData).length > 0 && (
                      <div className="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700 space-y-2 text-xs">
                        {Object.entries(otherData).map(([key, value]) => (
                          <div className="flex items-center space-x-2" key={key}>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 text-gray-400 dark:text-gray-500 flex-shrink-0">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                            <div>
                              <div className="font-medium text-gray-500 dark:text-gray-400">{formatKey(key)}</div>
                              <div className="text-gray-900 dark:text-white break-words">{String(value)}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )
            })}
          </div>

          {/* --- Pagination Controls --- */}
          {!loading && totalPages > 1 && (
            <div className="flex items-center justify-between mt-6 select-none">
              <button
                onClick={handlePrevPage}
                disabled={currentPage === 0}
                className="flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 mr-2">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
                ថយក្រោយ
              </button>
              
              <span className="text-sm font-medium text-gray-700 dark:text-gray-200">
                ទំព័រទី {currentPage + 1} នៃ {totalPages}
              </span>

              <button
                onClick={handleNextPage}
                disabled={currentPage >= totalPages - 1}
                className="flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                បន្ទាប់
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 ml-2">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </button>
            </div>
          )}
        </React.Fragment>
      );
    }

    // --- Sub-Component: Details Page ---
    function DetailsPage({ loading, stats, handleShareToTelegram }) {
      return (
        <div className="space-y-4 animate-fade-in">
          <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100 text-center mb-6">សរុបប្រចាំថ្ងៃ</h2>
          
          {loading ? (
             <div className="flex justify-center items-center py-10">
                <svg className="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
          ) : (
            <div className="space-y-4">
              
              <div className="relative bg-gradient-to-br from-red-500 to-pink-600 p-6 rounded-2xl shadow-lg overflow-hidden text-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="absolute top-4 right-4 w-20 h-20 text-white opacity-20 transform -rotate-12">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l3-3m0 0l-3-3m3 3H9" />
                </svg>
                <div className="relative z-10">
                  <div className="text-sm font-medium uppercase tracking-wider">និស្សិតកំពុងនៅខាងក្រៅ</div>
                  <div className="text-6xl font-bold my-2">{stats.studentsOut}</div>
                  <div className="text-sm opacity-90">នាក់ (មិនទាន់ចូលវិញ)</div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="relative bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-2xl shadow-lg overflow-hidden text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="absolute bottom-2 right-2 w-16 h-16 text-white opacity-20">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-4.682 2.72a.75.75 0 01-.058-.867 3 3 0 012.227-1.323 3 3 0 012.227 1.323.75.75 0 01-.058.867M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 15c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z" />
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.5a9.094 9.094 0 013.741-.479 3 3 0 014.682-2.72m4.682 2.72a.75.75 0 00.058-.867 3 3 0 00-2.227-1.323 3 3 0 00-2.227 1.323.75.75 0 00.058.867m-4.682 2.72a.75.75 0 01-.058-.867 3 3 0 012.227-1.323 3 3 0 012.227 1.323.75.75 0 01-.058.867M4.5 10.5h.008v.008H4.5V10.5z" />
                  </svg>
                  <div className="relative z-10">
                    <div className="text-sm font-medium uppercase tracking-wider">ចំនួននិស្សិតសរុប</div>
                    <div className="text-4xl font-bold my-1">{stats.totalStudents}</div>
                    <div className="text-sm opacity-90">(Unique)</div>
                  </div>
                </div>
                <div className="relative bg-gradient-to-br from-indigo-600 to-blue-700 p-6 rounded-2xl shadow-lg overflow-hidden text-white">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="absolute bottom-2 right-2 w-16 h-16 text-white opacity-20">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
                  </svg>
                  <div className="relative z-10">
                    <div className="text-sm font-medium uppercase tracking-wider">កំណត់ត្រាសរុប</div>
                    <div className="text-4xl font-bold my-1">{stats.totalRecords}</div>
                    <div className="text-sm opacity-90">(ថ្ងៃនេះ)</div>
                  </div>
                </div>
              </div>

              {/* === Export Section (RE-DESIGNED & CLEANED) === */}
              <div className="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 space-y-6">
                <div>
                  <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ចែករំលែកទៅ Telegram</h3>
                  <div className="grid grid-cols-1 gap-3">
                    <button
                      onClick={handleShareToTelegram}
                      className="flex items-center justify-center space-x-2 w-full px-4 py-3 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.32.283.68.283 1.093s-.103.773-.283 1.093m0-2.186l9.566-5.314m-9.566 5.314l9.566 5.314m0 0a2.25 2.25 0 100-2.186m0 2.186c-.18-.32-.283-.68-.283-1.093s.103-.773.283 1.093m0 2.186l-9.566-5.314m9.566 5.314l-9.566 5.314" />
                      </svg>
                      <span>Share Text</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // --- Sub-Component: Settings Page (UPDATED: Merged into one box) ---
    function SettingsPage({ showOnlyCheckout, onFilterToggle, currentBackground, onBackgroundChange }) {
      
      const Switch = ({ label, description, enabled, onToggle }) => (
        <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div className="flex-grow mr-4">
            <div className="text-base font-medium text-gray-900 dark:text-white">{label}</div>
            <div className="text-sm text-gray-500 dark:text-gray-400">{description}</div>
          </div>
          <button
            onClick={onToggle}
            className={`relative inline-flex items-center h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
              enabled ? 'bg-blue-600' : 'bg-gray-200'
            }`}
          >
            <span
              className={`inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
                enabled ? 'translate-x-5' : 'translate-x-0'
              }`}
            />
          </button>
        </div>
      );
      
      return (
        <div className="space-y-6 animate-fade-in">
          
          {/* Personal Settings */}
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
            <div className="p-4 border-b dark:border-gray-700">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white">ការកំណត់ផ្ទាល់ខ្លួន</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400">ការកំណត់ទាំងនេះ នឹងរក្សាទុកតែនៅលើឧបករណ៍របស់អ្នកប៉ុណ្ណោះ។</p>
            </div>
            
            {/* Filter Setting */}
            <div className="p-4 border-b dark:border-gray-700">
              <h4 className="text-base font-medium text-gray-900 dark:text-white mb-3">ការបង្ហាញទិន្នន័យ</h4>
              <Switch
                label="បង្ហាញតែនិស្សិតនៅខាងក្រៅ"
                description="បើកមុខងារនេះ ដើម្បីបង្ហាញតែនិស្សិតដែល Check Out (មិនទាន់ Check In) នៅលើទំព័រដើម។"
                enabled={showOnlyCheckout}
                onToggle={onFilterToggle}
              />
            </div>

            {/* Background Setting */}
            <div className="p-4">
              <h4 className="text-base font-medium text-gray-900 dark:text-white mb-3">ប្តូរផ្ទៃខាងក្រោយ (Background)</h4>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {backgroundOptions.map(option => (
                  <div 
                    key={option.id}
                    onClick={() => onBackgroundChange(option.class)}
                  >
                    <div 
                      className={`bg-swatch ${option.class} ${currentBackground === option.class ? 'selected' : ''}`}
                    ></div>
                    <div className="text-center text-sm text-gray-600 dark:text-gray-300 mt-1">{option.name}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
          
        </div>
      );
    }

    // --- Sub-Component: Image Modal ---
    function ImageModal({ imageUrl, onClose }) {
      useEffect(() => {
        document.body.style.overflow = 'hidden';
        return () => {
          document.body.style.overflow = 'auto';
        };
      }, []);

      return (
        <div 
          className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 animate-fade-in-fast"
          onClick={onClose}
        >
          <div 
            className="relative bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-4 max-w-md w-full"
            onClick={(e) => e.stopPropagation()}
          >
            <button
              onClick={onClose}
              className="absolute -top-4 -right-4 z-10 p-2 bg-white dark:bg-gray-700 dark:text-gray-200 rounded-full text-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors shadow-lg"
              title="បិទ"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            <img 
              src={imageUrl} 
              alt="រូបថតនិស្សិត" 
              className="w-full h-auto object-contain rounded-md max-h-[70vh]"
              referrerPolicy="no-referrer"
            />
          </div>
        </div>
      );
    }

    // 7. បញ្ជូន App ទៅកាន់ 'root' div (v17 API)
    ReactDOM.render(<App />, document.getElementById('root'));

  </script>
</body>
</html>

